'use server';

import { generateText, Message } from 'ai';
import { cookies } from 'next/headers';

import {
  deleteMessagesByChatIdAfterTimestamp,
  getMessageById,
  updateChatVisiblityById,
  updateChatTitleById,
} from '@/lib/db/queries';
import { VisibilityType } from '@/components/visibility-selector';
import { myProvider } from '@/lib/ai/providers';

export async function saveChatModelAsCookie(model: string) {
  const cookieStore = await cookies();
  cookieStore.set('chat-model', model);
}

export async function generateTitleFromUserMessage({
  message,
}: {
  message: Message;
}) {
  const { text: title } = await generateText({
    model: myProvider.languageModel('title-model'),
    system: `\n
    - Вы будете генерировать короткое название на основе сообщения пользователя.
    - убедитесь, что его длина не превышает 80 символов
    - заголовок должен быть кратким изложением сообщения пользователя
    - не используйте кавычки и двоеточия
    - заголовок должен быть на русском языке
    
    **ОБРАБОТКА ПРИВЕТСТВИЙ:**
    - Если сообщение содержит только приветствие (привет, здравствуйте, hi, hello) - создайте общее название: "Новый чат"
    - Если сообщение содержит приветствие + запрос - игнорируйте приветствие, фокусируйтесь на запросе
    
    **ОСОБЫЕ ПРАВИЛА ДЛЯ ОБРАЗОВАТЕЛЬНЫХ ЗАПРОСОВ:**
    - Если пользователь просит о курсах/обучении/развитии навыков - создайте название вида: "Курсы по [название навыка/области]"
    - Если пользователь упоминает конкретную должность или профессию - используйте: "Развитие [должность/профессия]"
    - Если пользователь говорит о карьерных целях - создайте: "План развития [область/направление]"
    - Если пользователь упоминает конкретные навыки - используйте: "Обучение [название навыка]"
    - Если пользователь спрашивает о тестах/экзаменах - используйте: "Тест по [предмет/тема]"
    - Если пользователь описывает рабочую ситуацию - создайте: "Решение [тип задачи/проблемы]"
    - Если пользователь говорит о личных целях - используйте: "Развитие [личная цель/навык]"
    - Избегайте общих фраз типа "приветствие", "консультация", "помощь"
    - Фокусируйтесь на конкретной области обучения или навыке, который хочет развить пользователь
    
    **АНАЛИЗ ДЕТАЛЬНЫХ СООБЩЕНИЙ:**
    - Если сообщение длинное и содержит подробное описание - выделите главную тему
    - Если упоминается несколько навыков - выберите наиболее важный
    - Если описывается ситуация на работе - сфокусируйтесь на решении проблемы
    - Если упоминается уровень (начинающий, средний, продвинутый) - включите в название
    - Если пользователь описывает свою должность и задачи - используйте: "Развитие [должность]"
    - Если пользователь говорит о проблемах в работе - используйте: "Решение [тип проблемы]"
    
    **ПРИОРИТЕТЫ ПРИ ВЫБОРЕ НАЗВАНИЯ:**
    1. Конкретные навыки (Excel, управление, презентации)
    2. Должности/роли (руководитель, менеджер, специалист)
    3. Области знаний (финансы, маркетинг, продажи)
    4. Типы задач (планирование, анализ, коммуникация)
    
    **ПРИМЕРЫ:**
    - "Привет! Хочу развить управленческие навыки" → "Курсы по управленческим навыкам"
    - "Здравствуйте, нужны курсы по Excel" → "Курсы по Excel"
    - "Hi, хочу стать руководителем проекта" → "Развитие руководителя проекта"
    - "Привет" → "Новый чат"
    - "Я работаю в отделе продаж и хочу улучшить навыки презентации" → "Обучение навыкам презентации"
    - "Нужно научиться управлять командой из 5 человек" → "Курсы по управлению командой"
    - "Хочу изучить основы финансового анализа" → "Курсы по финансовому анализу"
    - "Я менеджер проекта, у меня проблемы с коммуникацией в команде" → "Решение проблем коммуникации"
    - "Хочу стать руководителем отдела продаж" → "Развитие руководителя отдела продаж"`,
    prompt: JSON.stringify(message),
  });

  return title;
}

export async function deleteTrailingMessages({ id }: { id: string }) {
  const [message] = await getMessageById({ id });

  await deleteMessagesByChatIdAfterTimestamp({
    chatId: message.chatId,
    timestamp: message.createdAt,
  });
}

export async function updateChatVisibility({
  chatId,
  visibility,
}: {
  chatId: string;
  visibility: VisibilityType;
}) {
  await updateChatVisiblityById({ chatId, visibility });
}

export async function updateChatTitle({
  chatId,
  message,
}: {
  chatId: string;
  message: Message;
}) {
  const { text: title } = await generateText({
    model: myProvider.languageModel('title-model'),
    system: `\n
    - Вы будете генерировать короткое название на основе сообщения пользователя.
    - убедитесь, что его длина не превышает 80 символов
    - заголовок должен быть кратким изложением сообщения пользователя
    - не используйте кавычки и двоеточия
    - заголовок должен быть на русском языке
    
    **ОБРАБОТКА ПРИВЕТСТВИЙ:**
    - Если сообщение содержит только приветствие (привет, здравствуйте, hi, hello) - создайте общее название: "Новый чат"
    - Если сообщение содержит приветствие + запрос - игнорируйте приветствие, фокусируйтесь на запросе
    
    **ОСОБЫЕ ПРАВИЛА ДЛЯ ОБРАЗОВАТЕЛЬНЫХ ЗАПРОСОВ:**
    - Если пользователь просит о курсах/обучении/развитии навыков - создайте название вида: "Курсы по [название навыка/области]"
    - Если пользователь упоминает конкретную должность или профессию - используйте: "Развитие [должность/профессия]"
    - Если пользователь говорит о карьерных целях - создайте: "План развития [область/направление]"
    - Если пользователь упоминает конкретные навыки - используйте: "Обучение [название навыка]"
    - Если пользователь спрашивает о тестах/экзаменах - используйте: "Тест по [предмет/тема]"
    - Избегайте общих фраз типа "приветствие", "консультация", "помощь"
    - Фокусируйтесь на конкретной области обучения или навыке, который хочет развить пользователь
    
    **ПРИМЕРЫ:**
    - "Привет! Хочу развить управленческие навыки" → "Курсы по управленческим навыкам"
    - "Здравствуйте, нужны курсы по Excel" → "Курсы по Excel"
    - "Hi, хочу стать руководителем проекта" → "Развитие руководителя проекта"
    - "Привет" → "Новый чат"`,
    prompt: JSON.stringify(message),
  });

  // Обновляем название чата в базе данных
  await updateChatTitleById({ chatId, title });

  return title;
}
