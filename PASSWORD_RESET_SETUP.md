# Настройка функционала сброса пароля

## Обзор

Добавлен функционал для восстановления забытого пароля с использованием email-уведомлений через Nodemailer.

## Компоненты

### 1. База данных
- Добавлено поле `passwordResetToken` в таблицу `User`
- Миграция: `lib/db/migrations/0006_add_password_reset_token.sql`

### 2. Email сервис
- Файл: `lib/email.ts`
- Использует Nodemailer для отправки email через Gmail

### 3. Действия сервера
- Файл: `app/(auth)/password-reset-actions.ts`
- `requestPasswordReset` - запрос сброса пароля
- `resetPassword` - сброс пароля с токеном

### 4. Страницы
- `/reset-password` - страница запроса сброса пароля
- `/reset-password/[token]` - страница установки нового пароля

### 5. Компоненты UI
- Обновлен `components/auth-form.tsx` для поддержки скрытия полей
- Добавлена ссылка "Забыли пароль?" на странице логина

## Настройка

### 1. Переменные окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# Email Service Configuration
GMAIL_USER=your-gmail-address@gmail.com
GMAIL_APP_PASSWORD=your-16-character-app-password
PUBLIC_APP_URL=http://localhost:3000
```

### 2. Настройка Gmail

1. Включите двухфакторную аутентификацию в вашем Google аккаунте
2. Создайте пароль приложения:
   - Перейдите в настройки безопасности Google
   - Выберите "Пароли приложений"
   - Создайте новый пароль для "Почта"
   - Используйте этот 16-символьный пароль как `GMAIL_APP_PASSWORD`

### 3. Запуск миграции

```bash
npm run db:migrate
```

### 4. Установка зависимостей

```bash
npm install nodemailer @types/nodemailer
```

## Использование

1. Пользователь переходит на страницу логина
2. Нажимает "Забыли пароль?"
3. Вводит свой email
4. Получает письмо со ссылкой для сброса пароля
5. Переходит по ссылке и вводит новый пароль
6. Пароль обновляется и пользователь перенаправляется на страницу логина

## Безопасность

- Токены сброса пароля генерируются криптографически случайно
- Токены очищаются после использования
- Возвращается успех даже если email не найден (защита от перечисления)
- Пароли хешируются с использованием bcrypt

## Примечания

- Убедитесь, что `PUBLIC_APP_URL` настроен правильно для вашего окружения
- Для продакшена используйте SMTP сервис вместо Gmail для большей надежности
- Рассмотрите добавление срока действия токенов (например, 24 часа) 