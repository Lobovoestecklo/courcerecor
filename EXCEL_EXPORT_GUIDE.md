# Руководство по экспорту в Excel

## Обзор

В проекте добавлена функциональность экспорта табличных данных в формат Excel (.xlsx). Пользователи теперь могут скачивать таблицы с разделенными по столбцам и строкам данными в удобном для работы формате.

## Установленные зависимости

- `xlsx`: "^0.18.5" - библиотека для работы с Excel файлами
- `papaparse`: "^5.5.2" - библиотека для парсинга CSV данных
- `@radix-ui/react-dialog`: для диалоговых окон

## Функциональность

### 1. Экспорт из редактора таблиц

В компоненте `SpreadsheetEditor` добавлена кнопка "Export Excel" в верхней панели. При нажатии на неё:

- Открывается диалог для выбора имени файла
- Пользователь может ввести кастомное имя файла
- Файл скачивается только после подтверждения
- Показывается уведомление об успешном скачивании

### 2. Экспорт из артефакта таблицы

В артефакте `sheet` добавлена новая кнопка действия с иконкой Excel:

- При нажатии показывает уведомление с инструкцией
- Основной экспорт происходит через кнопку в редакторе
- Очищает пустые строки и ячейки

## Техническая реализация

### Утилиты экспорта (`lib/utils/excel-export.ts`)

#### `createExcelBlob(data)`
- Создает Excel файл из массива данных
- Возвращает Blob вместо автоматического скачивания
- Позволяет контролировать процесс скачивания

#### `downloadBlob(blob, filename)`
- Скачивает файл из Blob с указанным именем
- Используется для ручного скачивания

#### `exportToExcel(data, filename)`
- Обертка для автоматического скачивания (для обратной совместимости)
- Создает Blob и сразу скачивает файл

#### `csvToExcelData(csvContent)`
- Конвертирует CSV строку в массив массивов
- Использует `papaparse` для корректного парсинга
- Фильтрует пустые строки и ячейки

### Компоненты

#### `ExcelDownloadDialog` (`components/excel-download-dialog.tsx`)
- Диалог для выбора имени файла
- Поле ввода с предустановленным именем
- Кнопки "Отмена" и "Скачать"
- Обработка ошибок и уведомления

#### `SpreadsheetEditor`
- Обновлен для использования callback вместо автоматического скачивания
- Кнопка экспорта теперь открывает диалог
- Улучшенная обработка ошибок

#### `sheetArtifact`
- Обновлен для работы с диалогом
- Кнопка действия показывает инструкцию
- Основной экспорт через редактор

## Использование

### Для пользователей

1. **Создание таблицы**: Используйте AI для создания таблицы или откройте существующую
2. **Редактирование**: При необходимости отредактируйте данные в таблице
3. **Экспорт**: Нажмите кнопку "Export Excel" в редакторе таблиц
4. **Выбор имени**: В открывшемся диалоге введите желаемое имя файла
5. **Скачивание**: Нажмите "Скачать" для загрузки файла

### Для разработчиков

```typescript
import { createExcelBlob, downloadBlob, csvToExcelData } from '@/lib/utils/excel-export';

// Создание Excel файла без скачивания
const data = [
  ['ID', 'Name', 'Email'],
  ['1', 'John Doe', 'john@example.com'],
  ['2', 'Jane Smith', 'jane@example.com']
];

const blob = createExcelBlob(data);

// Скачивание по требованию
downloadBlob(blob, 'users.xlsx');

// Конвертация CSV в Excel
const csvContent = 'ID,Name,Email\n1,John Doe,john@example.com';
const excelData = csvToExcelData(csvContent);
const blob = createExcelBlob(excelData);
downloadBlob(blob, 'users.xlsx');
```

## Особенности

- **Контролируемое скачивание**: Файлы скачиваются только по требованию пользователя
- **Выбор имени файла**: Пользователь может задать кастомное имя файла
- **Очистка данных**: Пустые строки и ячейки автоматически удаляются
- **Корректный парсинг**: Используется `papaparse` для правильной обработки CSV
- **Уведомления**: Показываются toast-уведомления об успехе/ошибке
- **Обработка ошибок**: Все операции обернуты в try-catch блоки
- **Диалоговые окна**: Используется Radix UI для доступных диалогов

## Поддерживаемые форматы

- **Входные данные**: CSV строки, массивы массивов
- **Выходные данные**: Excel файлы (.xlsx)
- **Кодировка**: UTF-8
- **Разделители**: Запятые для CSV

## Ограничения

- Работает только в браузере (использует DOM API)
- Размер файла ограничен памятью браузера
- Требует поддержки Blob API в браузере
- Диалог требует поддержки Radix UI компонентов 